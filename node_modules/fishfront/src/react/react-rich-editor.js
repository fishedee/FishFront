import classname from "classnames";

var style = StyleSheet.create({
	root:{
		position:'relative',
		overflow:'hidden',
	},
	content:{

	},
	placeholder:{
		position:'absolute',
		display:'none',
		left:'0px',
		right:'0px',
		top:'0px',
		fontSize:'16px',
		color:'grey',
	}
});

export default React.createClass({
	getDefaultProps:function(){
	},
    _selection:function(node){
    	document.getSelection().removeAllRanges();
        var range = document.createRange();
        range.setStart(node[0], 0);
        range.collapse(true);
        document.getSelection().addRange(range);
    },
	_setEmptyHtml:function(){
		var emptyP = '<p><br/></p>';
		this._inputElement.innerHTML = emptyP;
		this._selection( this._inputElement.querySelectorAll('p') );
	},
	_checkPlaceHolder:function(){
		var self = this;
		var text = self._inputElement.textContent;
		var hasImage = self._inputElement.querySelectorAll("img").length > 0;
		if( hasImage == false && text == '' )
			self._placeholderElement.display = "block";
		else
			self._placeholderElement.display = "none";
	},
	_initEvent:function(){
		var self = this;
		self._inputElement.addEventListener('input',function(e){
			self._checkPlaceHolder();
			if ( self._inputElement.innerHTML == '') {
				self._setEmptyHtml();
				e.preventDefault();
			}
			if( self.props.onChange ){
				self.props.onChange(self._inputElement.innerHTML);
			}
		});
	},
	_initProps:function( props ){
		//设置html
		if( props.value != this._inputElement.innerHTML ){
			this._inputElement.innerHTML = props.value ;
		}
		if( this._inputElement.innerHTML == '' ){
			this._setEmptyHtml();
		}
		//设置placeholder
		this._placeholderElement.textContent = this.props.placeholder ;
		//check placeholder
		this._checkPlaceHolder();
	},
	bold:function(){
		document.execCommand("bold","false",null);
	},
	insertHtml:function(html){
		document.execCommand("insertHtml","false",html);
	},
	insertImage:function(src){
		document.execCommand("insertImage","false",src);
	},
	insertImageWithNewParagraph:function(src){
		var image = '<p><img src="'+src+'" style="max-width:80%;"></p>';
		this._inputElement.insertAdjacentHTML("beforeend",image); 
		if( this.props.onChange ){
			this.props.onChange(this._inputElement.innerHTML);
		}
	},
	componentDidMount:function(){
		this._inputElement = this.refs.input;
		this._placeholderElement = this.refs.placeholder;
		this._initProps( this.props );
		this._initEvent();
	},
	componentWillReceiveProps:function(nextProps){
		this._initProps( nextProps );
	},
	render: function() {
		return React.createElement(
			'div',
			{className:classname(style.root,this.props.className),style:this.props.style},
			React.createElement(
				'div',
				{className:style.content,ref:'input',autoFocus:'true',contentEditable:'true'}
			),
			React.createElement(
				'div',
				{className:style.placeholder,ref:'placeholder'}
			)
		);
	}
});